{% extends 'base.html' %}
{% block content %}
<div class="container py-5">

  <!-- Book Info -->
  <div class="row g-4">
    <div class="col-md-5">
      <img src="{{ url_for('static', filename='uploads/' ~ book.image_file) if book.image_file else url_for('static', filename='img/sample_book.jpg') }}"
           class="img-fluid rounded shadow-sm"
           alt="{{ book.title }}">
    </div>

    <div class="col-md-7">
      <h3 class="fw-bold">{{ book.title }}</h3>
      <p class="text-muted mb-1">
        {{ book.author or '—' }} • {{ book.category or '—' }}
      </p>

      <div class="h4 mt-2">
        {% if book.is_free %}
          <span class="text-success">FREE</span>
        {% else %}
          Rs {{ '%.0f'|format(book.price or 0) }}
        {% endif %}
      </div>

      <p class="mt-3">{{ book.description or '' }}</p>

      <!-- Contact Buttons -->
      <div class="d-flex gap-2 align-items-center mt-3 flex-wrap">

        <!-- WhatsApp -->
        <a class="btn btn-success"
           target="_blank"
           href="https://wa.me/{{ book.owner.phone|replace(' ', '') }}?text={{ 
  ('Hello, I am interested in your book: ' ~ book.title ~ ' - ' ~ request.url) | urlencode }}"
>
          <i class="bi bi-whatsapp"></i> Chat on WhatsApp
        </a>

        <!-- Wishlist -->
        {% if current_user.is_authenticated %}
          <form id="wish-form" method="post" action="{{ url_for('books.toggle_wishlist', book_id=book.id) }}">
            <button id="wishbtn" type="submit" class="btn btn-outline-danger btn-sm">
              {% if wished %}♥ In Wishlist{% else %}♡ Add to Wishlist{% endif %}
            </button>
          </form>
        {% else %}
          <a class="btn btn-outline-danger btn-sm" href="{{ url_for('auth.login') }}">
            ♡ Login to Wishlist
          </a>
        {% endif %}
      </div>

      <!-- Rating Summary -->
      <div class="mt-3 small text-muted">
        ★ {{ avg }} / 5 • {{ reviews|length }} reviews
      </div>
    </div>
  </div>

  <!-- Reviews -->
  <hr class="my-5">
  <div class="row">
    <div class="col-md-6">
      <h5 class="fw-bold">Reviews</h5>
      {% for r in reviews %}
        <div class="border rounded p-3 mb-2 bg-light">
          <strong>{{ r.author.name }}</strong>
          • <small class="text-muted">{{ r.created_at.strftime('%b %d, %Y') }}</small>
          <div class="mt-1">
            {% for i in range(1,6) %}
              {% if i <= r.rating %}
                <i class="bi bi-star-fill text-warning"></i>
              {% else %}
                <i class="bi bi-star text-warning"></i>
              {% endif %}
            {% endfor %}
          </div>
          <p class="mb-0">{{ r.comment }}</p>
        </div>
      {% else %}
        <div class="text-muted">No reviews yet.</div>
      {% endfor %}
    </div>

    <div class="col-md-6">
      <h5 class="fw-bold">Leave a Review</h5>
      <form method="post" class="card p-3 shadow-sm border-0">
        {{ form.hidden_tag() }}

        <!-- Star Rating -->
        <div class="mb-2">
          <label class="form-label">Rating</label>
          <div class="star-rating d-flex gap-1 fs-4">
            {% for i in range(1,6) %}
              <i class="bi bi-star" data-value="{{ i }}"></i>
            {% endfor %}
          </div>
          <input type="hidden" name="rating" id="rating-value" value="0">
        </div>

        <div class="mb-2">
          {{ form.comment.label }} 
          {{ form.comment(class_="form-control", rows=3) }}
        </div>

        {% if current_user.is_authenticated %}
          {{ form.submit(class_="btn btn-primary") }}
        {% else %}
          <a class="btn btn-outline-primary" href="{{ url_for('auth.login') }}">
            Login to Review
          </a>
        {% endif %}
      </form>
    </div>
  </div>
</div>

<!-- Scripts -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Wishlist AJAX
  const wishForm = document.getElementById('wish-form');
  if (wishForm) {
    wishForm.addEventListener('submit', function(event) {
      event.preventDefault();
      fetch(wishForm.action, {
        method: 'POST',
        body: new FormData(wishForm),
        credentials: 'include'
      })
      .then(response => response.json())
      .then(data => {
        const btn = document.getElementById('wishbtn');
        if (data.status === 'added') {
          btn.textContent = '♥ In Wishlist';
        } else if (data.status === 'removed') {
          btn.textContent = '♡ Add to Wishlist';
        }
        window.location.reload();
      });
    });
  }

  // Star rating
  const stars = document.querySelectorAll('.star-rating i');
  const ratingInput = document.getElementById('rating-value');

  stars.forEach(star => {
    star.addEventListener('click', function() {
      const value = this.getAttribute('data-value');
      ratingInput.value = value;

      stars.forEach(s => {
        if (s.getAttribute('data-value') <= value) {
          s.classList.remove('bi-star');
          s.classList.add('bi-star-fill', 'text-warning');
        } else {
          s.classList.add('bi-star');
          s.classList.remove('bi-star-fill');
        }
      });
    });
  });
});
</script>
{% endblock %}
